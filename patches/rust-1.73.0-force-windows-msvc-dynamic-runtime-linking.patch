From 83b2827d0c833b8676677a0053e5c6ea55be668b Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marc-Andr=C3=A9=20Moreau?= <mamoreau@devolutions.net>
Date: Thu, 2 Nov 2023 09:45:19 -0400
Subject: [PATCH] [PATCH] force Windows MSVC dynamic runtime linking

---
 src/bootstrap/bin/rustc.rs | 2 +-
 src/bootstrap/bootstrap.py | 2 +-
 src/bootstrap/builder.rs   | 2 +-
 src/bootstrap/cc_detect.rs | 4 ++--
 4 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/src/bootstrap/bin/rustc.rs b/src/bootstrap/bin/rustc.rs
index 10718aeb89f..6bff20c84c1 100644
--- a/src/bootstrap/bin/rustc.rs
+++ b/src/bootstrap/bin/rustc.rs
@@ -128,7 +128,7 @@ fn main() {
 
         if let Ok(s) = env::var("RUSTC_HOST_CRT_STATIC") {
             if s == "true" {
-                cmd.arg("-C").arg("target-feature=+crt-static");
+                cmd.arg("-C").arg("target-feature=-crt-static");
             }
             if s == "false" {
                 cmd.arg("-C").arg("target-feature=-crt-static");
diff --git a/src/bootstrap/bootstrap.py b/src/bootstrap/bootstrap.py
index f44a05a6b28..976f6510661 100644
--- a/src/bootstrap/bootstrap.py
+++ b/src/bootstrap/bootstrap.py
@@ -920,7 +920,7 @@ class RustBuild(object):
 
         target_features = []
         if self.get_toml("crt-static", build_section) == "true":
-            target_features += ["+crt-static"]
+            target_features += ["-crt-static"]
         elif self.get_toml("crt-static", build_section) == "false":
             target_features += ["-crt-static"]
         if target_features:
diff --git a/src/bootstrap/builder.rs b/src/bootstrap/builder.rs
index b3666192853..198b1e0a46d 100644
--- a/src/bootstrap/builder.rs
+++ b/src/bootstrap/builder.rs
@@ -1728,7 +1728,7 @@ pub fn cargo(
 
         if let Some(x) = self.crt_static(target) {
             if x {
-                rustflags.arg("-Ctarget-feature=+crt-static");
+                rustflags.arg("-Ctarget-feature=-crt-static");
             } else {
                 rustflags.arg("-Ctarget-feature=-crt-static");
             }
diff --git a/src/bootstrap/cc_detect.rs b/src/bootstrap/cc_detect.rs
index 2496c2a9db5..6f0985310ae 100644
--- a/src/bootstrap/cc_detect.rs
+++ b/src/bootstrap/cc_detect.rs
@@ -75,11 +75,11 @@ fn new_cc_build(build: &Build, target: TargetSelection) -> cc::Build {
         .host(&build.build.triple);
     match build.crt_static(target) {
         Some(a) => {
-            cfg.static_crt(a);
+            cfg.static_crt(false);
         }
         None => {
             if target.contains("msvc") {
-                cfg.static_crt(true);
+                cfg.static_crt(false);
             }
             if target.contains("musl") {
                 cfg.static_flag(true);
-- 
2.25.1

