name: LLVM prebuilt
on: workflow_dispatch
jobs:
  build:
    name: LLVM ${{matrix.version}} [${{matrix.arch}}-${{matrix.os}}] ${{matrix.distro}}
    runs-on: ${{matrix.runner}}
    strategy:
      fail-fast: false
      matrix:
        arch: [ x86_64, aarch64 ]
        os: [ windows, macos, ubuntu-22.04, ubuntu-24.04 ]
        version: [ 18.1.8, 20.1.8 ]

        include:
          - version: 18.1.8
            branch: release/18.x
          - version: 20.1.8
            branch: release/20.x

          - os: windows
            runner: windows-2022
          - os: macos
            runner: macos-latest
          - os: ubuntu-22.04
            runner: ubuntu-22.04
          - os: ubuntu-24.04
            runner: ubuntu-24.04

          - arch: x86_64
            os: windows
            msvc: amd64
          - arch: aarch64
            os: windows
            msvc: amd64_arm64

          - arch: x86_64
            os: macos
            osx_arch: x86_64
          - arch: aarch64
            os: macos
            osx_arch: arm64
    steps:
      - name: Clone project
        uses: actions/checkout@v4
        with:
          path: llvm-prebuilt

      - name: Configure Windows runner
        if: runner.os == 'Windows'
        run: |
          choco install --no-progress ninja 7zip
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat
          $VcpkgRootDir = "$PWD/vcpkg" -Replace '\\','/'
          $VcpkgArch = @{'x86_64'='x64';'aarch64'='arm64'}['${{matrix.arch}}']
          .\vcpkg install "zlib:${VcpkgArch}-windows-static-release"
          .\vcpkg install "libxml2:${VcpkgArch}-windows-static-release"
          echo "VCPKG_ARCH=$VcpkgArch" >> $Env:GITHUB_ENV
          echo "VCPKG_ROOT_DIR=$VcpkgRootDir" >> $Env:GITHUB_ENV

      - name: Configure macOS runner
        if: runner.os == 'macOS'
        run: |
          brew install ninja
          echo "MACOSX_DEPLOYMENT_TARGET=10.13" >> $GITHUB_ENV

      - name: Configure Linux runner
        if: runner.os == 'Linux'
        shell: pwsh
        run: |
          sudo apt update
          sudo apt install zstd xz-utils
          sudo apt install ninja-build
          sudo apt install g++-aarch64-linux-gnu

          # Install native packages
          sudo apt install libxml2-dev zlib1g-dev

          # Get Ubuntu release for cross-compilation packages
          $UbuntuRelease = lsb_release -rs
          
          # Download and extract arm64 packages using helper script
          $ScriptPath = "$Env:GITHUB_WORKSPACE/llvm-prebuilt/scripts/Get-UbuntuPackage.ps1"
          
          # Extract libxml2-dev for arm64
          $LibXmlPath = & $ScriptPath -PackageName "libxml2-dev" -Release $UbuntuRelease -Architecture "arm64"
          sudo cp -R "$LibXmlPath/usr/lib/aarch64-linux-gnu/" /usr/lib/aarch64-linux-gnu/
          
          # Extract zlib1g-dev for arm64
          $ZlibPath = & $ScriptPath -PackageName "zlib1g-dev" -Release $UbuntuRelease -Architecture "arm64"
          sudo cp -R "$ZlibPath/usr/lib/aarch64-linux-gnu/" /usr/lib/aarch64-linux-gnu/

      - name: Clone LLVM ${{matrix.version}}
        uses: actions/checkout@v4
        with:
          repository: llvm/llvm-project
          ref: ${{matrix.branch}}
          path: llvm-project

      - name: Patch LLVM
        shell: pwsh
        run: |
          if ('${{matrix.version}}' -eq '18.1.8') {
            git -C llvm-project apply ../llvm-prebuilt/patches/llvm-18-add-lld-install-targets.patch
            git -C llvm-project apply ../llvm-prebuilt/patches/llvm-18-add-llvm-name-prefix-to-llc-lli-opt-tools.patch
            git -C llvm-project apply ../llvm-prebuilt/patches/llvm-18-force-disable-clang-ast-introspection.patch
          } elseif ('${{matrix.version}}' -eq '20.1.8') {
            git -C llvm-project apply ../llvm-prebuilt/patches/llvm-20-add-lld-install-targets.patch
            git -C llvm-project apply ../llvm-prebuilt/patches/llvm-20-add-llvm-name-prefix-to-llc-lli-opt-tools.patch
          }

      - name: Enable Windows host environment
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64

      - name: Configure LLVM host tools
        shell: pwsh
        run: |
          cmake -G Ninja -S llvm-project/llvm -B llvm-host `
            -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra" `
            -DCMAKE_BUILD_TYPE=Release -Wno-dev

      - name: Build LLVM host tools
        shell: pwsh
        run: |
          cmake --build llvm-host --target llvm-tblgen clang-tblgen llvm-config
          if ('${{matrix.version}}' -eq '18.1.8') {
            cmake --build llvm-host --target clang-tidy-confusable-chars-gen clang-pseudo-gen
            # Build host tools needed for cross-compilation
            cmake --build llvm-host --target llvm-nm llvm-readobj
          } elseif ('${{matrix.version}}' -eq '20.1.8') {
            cmake --build llvm-host --target clang-tidy-confusable-chars-gen
            # Build host tools needed for cross-compilation in LLVM 20
            cmake --build llvm-host --target llvm-as llvm-link llvm-nm llvm-readobj opt
          }
          $HostBinPath = "$Env:GITHUB_WORKSPACE/llvm-host/bin"
          $ExeExt = if ($IsWindows) { ".exe" } else { "" }
          echo "LLVM_NATIVE_TOOL_DIR=$HostBinPath" >> $Env:GITHUB_ENV
          echo "LLVM_TABLEGEN=$HostBinPath/llvm-tblgen$ExeExt" >> $Env:GITHUB_ENV
          echo "CLANG_TABLEGEN=$HostBinPath/clang-tblgen$ExeExt" >> $Env:GITHUB_ENV
          echo "LLVM_CONFIG_PATH=$HostBinPath/llvm-config$ExeExt" >> $Env:GITHUB_ENV
          echo "LLVM_VERSION=${{matrix.version}}" >> $Env:GITHUB_ENV

      - name: Free disk space after host tools build
        if: runner.os == 'Linux'
        shell: pwsh
        run: |
          # Copy binaries to a temp location
          New-Item -ItemType Directory -Path llvm-host-tools -Force | Out-Null
          Copy-Item -Path llvm-host/bin/* -Destination llvm-host-tools/ -Recurse -Force
          
          # Remove entire llvm-host build directory to free maximum space
          Remove-Item -Path llvm-host -Recurse -Force
          
          # Restore just the bin directory
          New-Item -ItemType Directory -Path llvm-host/bin -Force | Out-Null
          Copy-Item -Path llvm-host-tools/* -Destination llvm-host/bin/ -Recurse -Force
          Remove-Item -Path llvm-host-tools -Recurse -Force
          
          # Show disk usage
          & df -h

      - name: Enable Windows target environment
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{matrix.msvc}}

      - name: Configure LLVM
        shell: pwsh
        run: |
          $TargetName = "${{matrix.arch}}-${{matrix.os}}"
          $CMakeToolchainFile = "$Env:GITHUB_WORKSPACE/llvm-prebuilt/cmake/$TargetName.cmake"
          $CMakeInitialCache = "$Env:GITHUB_WORKSPACE/llvm-prebuilt/cmake/llvm-distribution.cmake"

          $CMakeArgs = @()

          if ('${{matrix.os}}' -eq 'windows') {
            $ZLIB_ROOT_DIR="${Env:VCPKG_ROOT_DIR}/packages/zlib_${Env:VCPKG_ARCH}-windows-static"
            $ZLIB_INCLUDE_DIR="$ZLIB_ROOT_DIR/include"
            $ZLIB_LIBRARY="$ZLIB_ROOT_DIR/lib/zlib.lib"
            $CMakeArgs += @(
              "-DZLIB_INCLUDE_DIR=$ZLIB_INCLUDE_DIR",
              "-DZLIB_LIBRARY=$ZLIB_LIBRARY"
            )

            $LIBXML2_ROOT_DIR="${Env:VCPKG_ROOT_DIR}/packages/libxml2_${Env:VCPKG_ARCH}-windows-static"
            $LIBXML2_INCLUDE_DIR="$LIBXML2_ROOT_DIR/include"
            $LIBXML2_LIBRARY="$LIBXML2_ROOT_DIR/lib/libxml2.lib"
            $CMakeArgs += @(
              "-DLIBXML2_INCLUDE_DIR=$LIBXML2_INCLUDE_DIR",
              "-DLIBXML2_LIBRARY=$LIBXML2_LIBRARY"
            )
          }

          if ('${{matrix.os}}' -eq 'macos') {
            $AppleArch = @{'x86_64'='x86_64';'aarch64'='arm64'}['${{matrix.arch}}']
            $CMakeArgs += @("-DCMAKE_OSX_ARCHITECTURES=$AppleArch")
          }

          cmake -G Ninja -S llvm-project/llvm -B llvm-build $CMakeArgs `
            -DCMAKE_INSTALL_PREFIX=llvm-install `
            -DCMAKE_TOOLCHAIN_FILE="$CMakeToolchainFile" `
            -C $CMakeInitialCache -Wno-dev

      - name: Build LLVM
        run: cmake --build llvm-build

      - name: Install LLVM
        run: cmake --build llvm-build --target install-distribution

      - name: Package LLVM
        if: runner.os != 'Windows'
        run: |
          mv llvm-install clang+llvm-${{matrix.version}}-${{matrix.arch}}-${{matrix.os}}
          tar -cJf clang+llvm-${{matrix.version}}-${{matrix.arch}}-${{matrix.os}}.tar.xz clang+llvm-${{matrix.version}}-${{matrix.arch}}-${{matrix.os}}

      - name: Package LLVM
        if: runner.os == 'Windows'
        run: |
          ren llvm-install clang+llvm-${{matrix.version}}-${{matrix.arch}}-${{matrix.os}}
          cmd.exe /c "7z a -ttar -snl -so clang+llvm-${{matrix.version}}-${{matrix.arch}}-${{matrix.os}}.tar clang+llvm-${{matrix.version}}-${{matrix.arch}}-${{matrix.os}} | 7z a -si clang+llvm-${{matrix.version}}-${{matrix.arch}}-${{matrix.os}}.tar.xz"

      - name: Upload LLVM package
        uses: actions/upload-artifact@v4
        with:
          name: clang+llvm-${{matrix.version}}-${{matrix.arch}}-${{matrix.os}}
          path: clang+llvm-${{matrix.version}}-${{matrix.arch}}-${{matrix.os}}.tar.xz
